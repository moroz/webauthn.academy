---
title: Implementing Webauthn in Golang
---

This section is dedicated to a framework-agnostic implementation of a Webauthn workflow using the Go programming language.
Whenever possible, I try to use just the standard library, so with enough knowledge of the Go ecosystem, you should be able to modify the solution to use your preferred libraries.

## Initial setup

The following walkthrough sets up a password authentication from scratch. Once this text is finalized, you will be able to skip to the section where I start implementing Webauthn. For now, you can just follow along.

Command-line tools we will be using: [mise](https://mise.jdx.dev/), [goose](https://github.com/pressly/goose), [direnv](https://direnv.net/).
For persistence, I will be using PostgreSQL 16.2, but any reasonably modern version of PostgreSQL should work too.

Create a directory for the new project:

```plain
mkdir academy-go
```

Ensure Golang is installed (here using [mise](https://mise.jdx.dev/)):

```plain
cd academy-go
mise install go@1.22.3
mise local go
```

Initialize a Go module in this directory.

```shell
# Swap "moroz" for your Github username
go mod init github.com/moroz/webauthn-academy-go
```

Initialize a Git repository in this directory:

```shell
git init
git branch -M main
git add .
git commit -m "Initial commit"
```

We will be writing database migrations using [goose](https://github.com/pressly/goose).
Install goose in your PATH using the following command:

```plain
go install github.com/pressly/goose/v3/cmd/goose@latest
```

Install [sqlx](https://jmoiron.github.io/sqlx/) and the PostgreSQL driver [pq](https://github.com/lib/pq):

```plain
go install github.com/lib/pq
go install github.com/jmoiron/sqlx
```

Now, let's set up a database. First, create a `.envrc` file. We will be using this file to set environment variables using [direnv](https://direnv.net/).

```shell
export PGDATABASE=academy_dev
export DATABASE_URL="postgres://postgres:postgres@localhost/${PGDATABASE}?sslmode=disable"
export GOOSE_MIGRATION_DIR=db/migrations
export GOOSE_DRIVER=postgres
export GOOSE_DBSTRING="$DATABASE_URL"
```

By setting the `GOOSE_MIGRATION_DIR` environment variable, we instruct Goose to look for migration files in the `db/migrations` directory.
The `GOOSE_DBSTRING` makes Goose run the migration scripts against our development database.
In the command line, source this script or run `direnv allow` to apply these settings:

```shell
# If you have configured direnv
direnv allow
# Otherwise just source this file
source .envrc
```

Generate a migration file for the `users` table:

```plain
goose create create_users sql
```

In the newly created migration file (called `db/migrations/20240511103916_create_users.sql` in my case, the timestamp part will be different for you), add instructions to create and tear down a `users` table:

```sql
-- +goose Up
-- +goose StatementBegin
create extension if not exists citext;

create table users (
  id bigint primary key generated by default as identity,
  email citext not null unique,
  display_name varchar(80) not null,
  password_hash varchar(100) not null,
  inserted_at timestamp(0) not null default (now() at time zone 'utc'),
  updated_at timestamp(0) not null default (now() at time zone 'utc')
);
-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin
drop table users;
-- +goose StatementEnd
```

In `types/user.go`, define a struct representing a record in the `users` table:

```go
package types

import "time"

type User struct {
	ID           int       `db:"id"`
	Email        string    `db:"email"`
	DisplayName  string    `db:"display_name"`
	PasswordHash string    `db:"password_hash"`
	InsertedAt   time.Time `db:"inserted_at"`
	UpdatedAt    time.Time `db:"updated_at"`
}
```

```go
package store

import (
	"github.com/jmoiron/sqlx"
	"github.com/moroz/webauthn-academy-go/types"
)

type userStore struct {
	db *sqlx.DB
}

func UserStore(db *sqlx.DB) userStore {
	return userStore{db}
}

const insertUserQuery = `insert into users (email, display_name, password_hash) values ($1, $2, $3) returning *`

func (s *userStore) InsertUser(user *types.User) (*types.User, error) {
	var result types.User
	err := s.db.Get(&result, insertUserQuery, user.Email, user.DisplayName, user.PasswordHash)
	if err != nil {
		return nil, err
	}
	return &result, nil
}
```
